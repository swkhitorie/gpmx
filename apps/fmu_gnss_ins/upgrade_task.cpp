#include "upgrade_task.h"

#include <board_config.h>

#include <FreeRTOS.h>
#include <task.h>
#include <stdio.h>
#include <string.h>

/**
uint8_t mavlink_reboot_id1[41] = {
    0xfe, 0x21, 0x72, 0xff, 0x00, 0x4c, 0x00, 0x00, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xf6, 0x00, 0x01, 0x00, 0x00, 0x53, 0x6b,
};
uint8_t mavlink_reboot_id0[41] = {
    0xfe, 0x21, 0x45, 0xff, 0x00, 0x4c, 0x00, 0x00, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xf6, 0x00, 0x00, 0x00, 0x00, 0xcc, 0x37,
};
 */


void upgrade_task(void *p)
{
    uint32_t ticks = 0;
    uint32_t lst_wakeup = xTaskGetTickCount();

    uint8_t rbuff[64] = {0};
    uint8_t sz = 0;

    for (;;) {
        vTaskDelayUntil(&lst_wakeup, pdMS_TO_TICKS(100));

        sz = fread(rbuff, 64, 1, stdin);
        if (sz > 41) {
            for (int i = 0; i < sz; i++) {
                if (rbuff[i] == 0xfe) {
                    if ((rbuff[i+1] == 0x21) &&
                        (rbuff[i+2] == 0x45 || rbuff[i+2] == 0x72) &&
                        (rbuff[i+3] == 0xff) &&
                        (rbuff[i+4] == 0x00) &&
                        (rbuff[i+5] == 0x4c))
                    {
                        board_reboot();
                    }
                }
            }
        }
    }
}
